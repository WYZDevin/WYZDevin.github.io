---
import { PUBLIC_ACCESS_TOKEN } from 'astro:env/client'
import request from 'graphql-request'
import { GetGithubContributions } from '@/lib/graphql'
import type { GithubContributionData } from '@/types'

import BentoGithubActivityChart from './BentoItemGithubActivityChart'

// Fetch GitHub contributions data at build time
const getGithubContributions = async (): Promise<GithubContributionData> => {
  const response = await request({
    url: 'https://api.github.com/graphql',
    document: GetGithubContributions,
    variables: { userName: 'WYZDevin' },
    requestHeaders: {
      Authorization: `Bearer ${PUBLIC_ACCESS_TOKEN}`
    }
  })

  const parsedResponse = (response as any).user.contributionsCollection
    .contributionCalendar

  return {
    lastPushedAt: (response as any).user.repositories.nodes[0].pushedAt,
    totalContributions: parsedResponse.totalContributions,
    contributions: parsedResponse.weeks.flatMap((week: any) => {
      return week.contributionDays.map((day: any) => {
        return {
          count: day.contributionCount,
          date: day.date.replace(/-/g, '/')
        }
      })
    })
  }
}

let data = null
try {
  data = await getGithubContributions()
} catch (error) {
  console.error('Failed to fetch GitHub contributions:', error)
}

---

{
  data ? (
    <BentoGithubActivityChart {...data} client:only='react' />
  ) : (
    // TODO: handle error
    <p>Something went wrong ðŸ˜”</p>
  )
}
